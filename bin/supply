#!/usr/bin/env bash

echo "-----> VulsBuildpack/supply"

BIN_DIR=$(cd $(dirname $0); pwd)
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
INDEX=$4
STAGING_DIR=$DEPS_DIR/$INDEX

MONIT_VERSION=${MONIT_VERSION:-5.27.0}
MONIT_ARCHIVE=${MONIT_ARCHIVE:-monit-${MONIT_VERSION}.tar.gz}
MONIT_URL=${MONIT_URL:-https://bitbucket.org/tildeslash/monit/downloads/${MONIT_ARCHIVE}}
MONIT_SHA1SUM=${MONIT_SHA1SUM:-${MONIT_URL}.sha256}
MONIT_CRONTAB=${MONIT_CRONTAB:-${STAGING_DIR}/dist/monitrc}
MONIT_CRONTAB_CMD=${MONIT_CRONTAB_CMD:-"5 6 * * * /home/vcap/app/.profile.d/00-run-scan.sh"}

VULS_VERSION=${VULS_VERSION:-0.11.0}
VULS_URL="${VULS_URL:-https://github.com/future-architect/vuls/releases/download/v${VULS_VERSION}/vuls_${VULS_VERSION}_linux_amd64.tar.gz}"


echo "Installing the vuls to ${STAGING_DIR}"

mkdir -p $STAGING_DIR
mkdir -p $STAGING_DIR
mkdir -p $BUILD_DIR/.profile.d

cp -r $ROOT_DIR/lib/dist $STAGING_DIR/

# echo "Download monit asset from ${MONIT_URL}"
# pushd /tmp

# curl -L -O $MONIT_URL

# curl -L -O $MONIT_SHA1SUM

# sha256sum -c $MONIT_ARCHIVE.sha256

# tar -C /tmp -xf $MONIT_ARCHIVE

# (
#   cd /tmp/$(basename $MONIT_ARCHIVE .tar.gz) && \
#   ./configure --prefix=$STAGING_DIR --without-pam && \
#   make && \
#   make install
# )

# popd

echo "Download vuls asset from ${VULS_URL}"
DOWNLOAD_PATH=$STAGING_DIR/vuls.tar.gz

mkdir -p $STAGING_DIR/bin

curl -L -o $DOWNLOAD_PATH $VULS_URL

tar -C $STAGING_DIR/bin -xf $DOWNLOAD_PATH vuls

if [ -f $ROOT_DIR/lib/vuls ]; then
  cp $ROOT_DIR/lib/vuls $BUILD_DIR/vuls
  chmod +x $STAGING_DIR/bin/vuls
fi

rm -rf $DOWNLOAD_PATH

cp $ROOT_DIR/lib/dist/monitrc $BUILD_DIR/monitrc
cp $ROOT_DIR/lib/dist/config.toml $BUILD_DIR/config.toml
cp $ROOT_DIR/lib/run-scan.sh $STAGING_DIR/binrun-scan
#sed -i "s/##INDEX##/${INDEX}/" $STAGING_DIR/bin/run-scan

chmod +x $STAGING_DIR/bin/run-scan

# echo "Configuring crontab"
# chmod 0700 $STAGING_DIR/dist/monitrc

cp $ROOT_DIR/launch.yml $STAGING_DIR/launch.yml
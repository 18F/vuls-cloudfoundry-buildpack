#!/usr/bin/env bash

echo "-----> VulsBuildpack/supply"

BIN_DIR=$(cd $(dirname $0); pwd)
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
INDEX=$4

VULS_URL="${VULS_URL:-https://github.com/future-architect/vuls/releases/download/v0.9.6/vuls_0.9.6_linux_amd64.tar.gz}"
VULS_DIR=$DEPS_DIR/$INDEX

echo "Installing the vuls executable"

mkdir -p $VULS_DIR/depscan
mkdir -p $BUILD_DIR/.profile.d

cp -r $ROOT_DIR/lib/dist $VULS_DIR/depscan/

echo "Download vuls asset from ${VULS_URL}"
curl -L -o $VULS_DIR/vuls.tar.gz $VULS_URL

tar -C $VULS_DIR/depscan -xf $VULS_DIR/vuls.tar.gz vuls

rm -rf $VULS_DIR/vuls.tar.gz

if [ -f $ROOT_DIR/lib/vuls ]; then
  cp $ROOT_DIR/lib/vuls $BUILD_DIR/depscan/vuls
  chmod +x $VULS_DIR/depscan/vuls
fi

cp $ROOT_DIR/lib/run-scan.sh $BUILD_DIR/.profile.d/00-run-scan.sh
sed -i "s/##INDEX##/${INDEX}/" $BUILD_DIR/.profile.d/00-run-scan.sh

chmod +x $BUILD_DIR/.profile.d/00-run-scan.sh
